definitions:
  services:
    docker1:
      memory: 7168
      type: docker
pipelines:
  branches:
    staging:
      - step:
          size: 2x # Total memory is 8GB
          name: Build and Push to ACR Staging
          services:
            - docker1
          script:
            - export IMAGE_TAG=$BITBUCKET_BUILD_NUMBER
            - echo "$ACR_PASSWORD" | docker login -u "$ACR_USERNAME"
              --password-stdin "$ACR_REGISTRY"
            - docker build -t "$ACR_REGISTRY/$ACR_IMAGE_NAME:$IMAGE_TAG" .
            - docker push "$ACR_REGISTRY/$ACR_IMAGE_NAME:$IMAGE_TAG"

      - step:
          name: Deploy to AKS Staging
          script:
            - export IMAGE_TAG=$BITBUCKET_BUILD_NUMBER
            - export ENV_SECRET=$ENV_SECRET_STAGING
            - export ENV_NAME=$ENV_NAME_STAGING
            - export ENV_ACR=$ENV_ACR_STAGING
            - apt-get update && apt-get install -y bash gettext
            - envsubst < deployment.yaml > deployment.yaml.tmp && mv deployment.yaml.tmp deployment.yaml
            - cat deployment.yaml  # Optional: for debugging purposes to see the replaced content
            - pipe: microsoft/azure-aks-deploy:1.0.2
              variables:
                AZURE_APP_ID: $AZURE_APP_ID
                AZURE_PASSWORD: $AZURE_PASSWORD
                AZURE_TENANT_ID: $AZURE_TENANT_ID
                AZURE_AKS_NAME: $AKS_CLUSTER_NAME
                AZURE_RESOURCE_GROUP: $RESOURCE_GROUP
                KUBECTL_COMMAND: 'apply'
                KUBECTL_ARGUMENTS: '-f deployment.yaml'
                DEBUG: 'true'
    beta:
      - step:
          size: 2x # Total memory is 8GB
          name: Build and Push to ACR Beta
          services:
            - docker1
          script:
            - export IMAGE_TAG=$BITBUCKET_BUILD_NUMBER
            - echo "$ACR_PASSWORD" | docker login -u "$ACR_USERNAME"
              --password-stdin "$ACR_REGISTRY"
            - docker build -t "$ACR_REGISTRY/$ACR_IMAGE_NAME_BETA:$IMAGE_TAG" .
            - docker push "$ACR_REGISTRY/$ACR_IMAGE_NAME_BETA:$IMAGE_TAG"

      - step:
          name: Deploy to AKS Beta
          script:
            - export IMAGE_TAG=$BITBUCKET_BUILD_NUMBER
            - export ENV_SECRET=$ENV_SECRET_BETA
            - export ENV_NAME=$ENV_NAME_BETA
            - export ENV_ACR=$ENV_ACR_BETA
            - apt-get update && apt-get install -y bash gettext
            - envsubst < deployment.yaml > deployment.yaml.tmp && mv deployment.yaml.tmp deployment.yaml
            - cat deployment.yaml  # Optional: for debugging purposes to see the replaced content
            - pipe: microsoft/azure-aks-deploy:1.0.2
              variables:
                AZURE_APP_ID: $AZURE_APP_ID
                AZURE_PASSWORD: $AZURE_PASSWORD
                AZURE_TENANT_ID: $AZURE_TENANT_ID
                AZURE_AKS_NAME: $AKS_CLUSTER_NAME
                AZURE_RESOURCE_GROUP: $RESOURCE_GROUP
                KUBECTL_COMMAND: 'apply'
                KUBECTL_ARGUMENTS: '-f deployment.yaml -n beta'
                DEBUG: 'true'
    master:
      - step:
          size: 2x # Total memory is 8GB
          name: Build and Push to ACR Prod
          services:
            - docker1
          script:
            - export IMAGE_TAG=$BITBUCKET_BUILD_NUMBER
            - echo "$ACR_PASSWORD" | docker login -u "$ACR_USERNAME"
              --password-stdin "$ACR_REGISTRY"
            - docker build -t "$ACR_REGISTRY/$ACR_IMAGE_NAME_BETA:$IMAGE_TAG" .
            - docker push "$ACR_REGISTRY/$ACR_IMAGE_NAME_BETA:$IMAGE_TAG"

      - step:
          name: Deploy to AKS Prod
          script:
            - export IMAGE_TAG=$BITBUCKET_BUILD_NUMBER
            - export ENV_SECRET=$ENV_SECRET_PROD
            - export ENV_NAME=$ENV_NAME_PROD
            - export ENV_ACR=$ENV_ACR_PROD
            - apt-get update && apt-get install -y bash gettext
            - envsubst < deployment.yaml > deployment.yaml.tmp && mv deployment.yaml.tmp deployment.yaml
            - cat deployment.yaml  # Optional: for debugging purposes to see the replaced content
            - pipe: microsoft/azure-aks-deploy:1.0.2
              variables:
                AZURE_APP_ID: $AZURE_APP_ID
                AZURE_PASSWORD: $AZURE_PASSWORD
                AZURE_TENANT_ID: $AZURE_TENANT_ID
                AZURE_AKS_NAME: $AKS_CLUSTER_NAME
                AZURE_RESOURCE_GROUP: $RESOURCE_GROUP
                KUBECTL_COMMAND: 'apply'
                KUBECTL_ARGUMENTS: '-f deployment.yaml -n prod'
                DEBUG: 'true'